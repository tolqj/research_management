# 审计日志功能测试指南

## 测试环境准备

### 1. 启动后端服务

```bash
cd backend
python main.py
```

验证：访问 http://localhost:8000/api/docs，应该能看到新增的 **"安全审计"** API分组

### 2. 启动前端服务

```bash
cd frontend
npm run dev
```

访问：http://localhost:5173

---

## 测试步骤

### 测试1：管理员查看审计日志

1. **登录系统**
   - 用户名：`admin`
   - 密码：`Admin@123`

2. **检查菜单**
   - 左侧菜单应该显示 **"审计日志"** 菜单项
   - 图标：Document图标

3. **访问审计日志页面**
   - 点击 "审计日志" 菜单
   - 应该跳转到审计日志列表页面
   - 页面显示最近的审计记录

4. **测试查询功能**
   - 在"用户名"输入框输入 `admin`，点击"搜索"
   - 应该只显示admin用户的操作记录
   
   - 在"操作类型"输入框输入 `登录`，点击"搜索"
   - 应该只显示登录相关的操作
   
   - 选择"状态" = `失败`，点击"搜索"
   - 应该只显示失败的操作

5. **测试详情查看**
   - 点击表格行左侧的箭头，展开详情
   - 应该显示完整的日志信息（请求路径、用户代理、操作详情等）
   
   - 点击"详情"按钮
   - 应该弹出对话框，显示完整的日志信息

6. **测试统计功能**
   - 点击右上角"查看统计"按钮
   - 应该弹出统计对话框
   - 显示：操作类型TOP10、活跃用户TOP10、操作结果统计
   - 切换统计范围（7天/30天/90天），数据应该更新

7. **测试分页**
   - 如果日志超过20条，应该显示分页器
   - 点击下一页，应该加载下一页数据
   - 修改每页条数，数据应该重新加载

### 测试2：科研秘书查看审计日志

1. **创建科研秘书账号**（如果没有）
   - 使用admin账号登录
   - 进入"用户管理"
   - 创建新用户，角色选择"科研秘书"

2. **登录科研秘书账号**
   - 退出admin账号
   - 使用科研秘书账号登录

3. **检查菜单**
   - 左侧菜单应该显示 **"审计日志"** 菜单项
   - **不应该显示** "用户管理" 菜单项（无权限）

4. **访问审计日志**
   - 点击"审计日志"菜单
   - 应该能够正常查看审计日志
   - 功能与管理员相同

### 测试3：普通教师无法访问

1. **登录普通教师账号**
   - 使用普通教师账号登录

2. **检查菜单**
   - 左侧菜单 **不应该显示** "审计日志" 菜单项

3. **直接访问（可选）**
   - 在浏览器地址栏输入：http://localhost:5173/system/audit-log
   - 应该被拒绝访问，显示权限不足提示

### 测试4：审计日志自动记录

1. **执行一些操作**
   - 登录/登出
   - 创建项目
   - 编辑论文
   - 删除经费记录
   - 修改密码

2. **查看审计日志**
   - 进入审计日志页面
   - 应该能看到刚才执行的操作记录
   - 记录包含：操作类型、时间、IP地址等

3. **查看失败操作**
   - 故意输入错误密码登录
   - 查看审计日志，筛选"状态=失败"
   - 应该看到登录失败记录

---

## API测试（可选）

### 使用Swagger测试

1. 访问：http://localhost:8000/api/docs

2. 找到 **"安全审计"** 分组

3. 测试 `GET /api/audit/logs`
   - 点击 "Try it out"
   - 填写参数（可选）
   - 点击 "Execute"
   - 检查响应

4. 测试 `GET /api/audit/logs/statistics`
   - 点击 "Try it out"
   - 设置days=7
   - 点击 "Execute"
   - 检查统计数据

5. 测试 `GET /api/audit/logs/{log_id}`
   - 从列表查询中获取一个log_id
   - 点击 "Try it out"
   - 填入log_id
   - 点击 "Execute"
   - 检查详细信息

---

## 预期结果

### ✅ 成功标准

1. **菜单显示**
   - 管理员和科研秘书可以看到"审计日志"菜单
   - 普通教师看不到该菜单

2. **页面功能**
   - 列表正常显示
   - 搜索筛选正常工作
   - 详情查看正常
   - 统计功能正常
   - 分页功能正常

3. **权限控制**
   - 管理员和科研秘书可以访问
   - 普通教师无法访问

4. **日志记录**
   - 所有操作自动记录
   - 记录信息完整准确

### ❌ 常见问题

#### 问题1：菜单不显示

**原因**：权限判断逻辑问题

**检查**：
- 确认当前登录用户角色
- 检查`layout.vue`中的menuRoutes计算逻辑

#### 问题2：API 404错误

**原因**：后端路由未注册

**检查**：
- 确认`main.py`中已导入`audit_log`
- 确认路由已注册

#### 问题3：数据不显示

**原因**：数据库中没有审计日志

**解决**：
- 执行一些操作（登录、创建项目等）
- 刷新审计日志页面

#### 问题4：权限错误

**原因**：Token过期或权限不足

**解决**：
- 重新登录
- 确认使用管理员或科研秘书账号

---

## 测试数据

### 快速生成测试数据

执行以下操作来生成审计日志：

```bash
# 多次登录/登出
1. 登录系统
2. 登出系统
3. 重复5-10次

# 创建数据
1. 创建3个项目
2. 创建5篇论文
3. 创建10条经费记录
4. 创建3个成果

# 修改数据
1. 编辑2个项目
2. 编辑3篇论文

# 删除数据
1. 删除1条经费记录
2. 删除1个成果

# 失败操作
1. 输入错误密码登录3次
2. 尝试访问无权限的页面
```

执行完这些操作后，审计日志应该有30-50条记录。

---

## 验收检查清单

- [ ] 管理员可以访问审计日志页面
- [ ] 科研秘书可以访问审计日志页面
- [ ] 普通教师无法访问审计日志页面
- [ ] 审计日志列表正常显示
- [ ] 用户名搜索功能正常
- [ ] 操作类型搜索功能正常
- [ ] 模块筛选功能正常
- [ ] 状态筛选功能正常
- [ ] 日期范围筛选功能正常
- [ ] 展开详情功能正常
- [ ] 详情按钮功能正常
- [ ] 统计功能正常显示
- [ ] 统计范围切换正常
- [ ] 分页功能正常
- [ ] 登录操作被记录
- [ ] 创建操作被记录
- [ ] 编辑操作被记录
- [ ] 删除操作被记录
- [ ] 失败操作被记录
- [ ] 日志信息完整准确

---

**测试完成后，如有问题请记录并反馈！**
