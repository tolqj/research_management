# å®‰å…¨è§„èŒƒæ–‡æ¡£

> ç¬¦åˆ**ç­‰ä¿äºŒçº§æ ‡å‡†**çš„å®‰å…¨è®¾è®¡ä¸å®ç°è¯´æ˜

## ğŸ“‹ ç›®å½•

- [ç­‰ä¿äºŒçº§æ¦‚è¿°](#ç­‰ä¿äºŒçº§æ¦‚è¿°)
- [èº«ä»½é‰´åˆ«](#èº«ä»½é‰´åˆ«)
- [è®¿é—®æ§åˆ¶](#è®¿é—®æ§åˆ¶)
- [å®‰å…¨å®¡è®¡](#å®‰å…¨å®¡è®¡)
- [æ•°æ®å®Œæ•´æ€§](#æ•°æ®å®Œæ•´æ€§)
- [å®‰å…¨é…ç½®](#å®‰å…¨é…ç½®)
- [å®‰å…¨æœ€ä½³å®è·µ](#å®‰å…¨æœ€ä½³å®è·µ)
- [åº”æ€¥å“åº”](#åº”æ€¥å“åº”)

---

## ç­‰ä¿äºŒçº§æ¦‚è¿°

### ä»€ä¹ˆæ˜¯ç­‰ä¿äºŒçº§

ç­‰çº§ä¿æŠ¤ï¼ˆç­‰ä¿ï¼‰æ˜¯ä¸­å›½ä¿¡æ¯å®‰å…¨ç­‰çº§ä¿æŠ¤åˆ¶åº¦çš„ç®€ç§°ã€‚äºŒçº§ç³»ç»Ÿé€‚ç”¨äºï¼š
- ä¸€èˆ¬ä¼ä¸šä¿¡æ¯ç³»ç»Ÿ
- é«˜æ ¡ç§‘ç ”ç®¡ç†ç³»ç»Ÿ
- çœçº§æ”¿åºœéƒ¨é—¨ç³»ç»Ÿ

### ç­‰ä¿äºŒçº§æ ¸å¿ƒè¦æ±‚

| ç±»åˆ« | è¦æ±‚ |
|------|------|
| **èº«ä»½é‰´åˆ«** | ç”¨æˆ·èº«ä»½å”¯ä¸€æ€§ã€å¯†ç å¤æ‚åº¦ã€ç™»å½•å¤±è´¥å¤„ç† |
| **è®¿é—®æ§åˆ¶** | æƒé™æœ€å°åŒ–ã€èµ„æºçº§è®¿é—®æ§åˆ¶ |
| **å®‰å…¨å®¡è®¡** | å®Œæ•´çš„æ“ä½œæ—¥å¿—ã€å®¡è®¡æ—¥å¿—ä¿æŠ¤ |
| **æ•°æ®å®Œæ•´æ€§** | æ•°æ®æ ¡éªŒã€äº‹åŠ¡ä¿æŠ¤ |
| **å‰©ä½™ä¿¡æ¯ä¿æŠ¤** | æ•æ„Ÿä¿¡æ¯ä¸å¯é€†åŠ å¯† |

### æœ¬ç³»ç»Ÿçš„åˆè§„å®ç°

âœ… å·²å®ç°çš„å®‰å…¨ç‰¹æ€§ï¼š
- ç”¨æˆ·èº«ä»½å”¯ä¸€æ€§éªŒè¯
- å¯†ç å¤æ‚åº¦ç­–ç•¥ï¼ˆ8ä½+å¤§å°å†™+æ•°å­—+ç‰¹æ®Šå­—ç¬¦ï¼‰
- å¯†ç å®šæœŸæ›´æ¢æé†’ï¼ˆ90å¤©ï¼‰
- ç™»å½•å¤±è´¥é”å®šæœºåˆ¶ï¼ˆ5æ¬¡/30åˆ†é’Ÿï¼‰
- åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)
- å®Œæ•´çš„æ“ä½œå®¡è®¡æ—¥å¿—
- JWTä¼šè¯ç®¡ç†
- æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨
- SQLæ³¨å…¥é˜²æŠ¤
- XSSé˜²æŠ¤

---

## èº«ä»½é‰´åˆ«

### 1. å¯†ç ç­–ç•¥

#### å¯†ç å¤æ‚åº¦è¦æ±‚

```python
# backend/utils/password_policy.py

class PasswordPolicy:
    """ç­‰ä¿äºŒçº§å¯†ç ç­–ç•¥"""
    
    MIN_LENGTH = 8              # æœ€å°é•¿åº¦
    REQUIRE_UPPERCASE = True    # å¿…é¡»åŒ…å«å¤§å†™å­—æ¯
    REQUIRE_LOWERCASE = True    # å¿…é¡»åŒ…å«å°å†™å­—æ¯
    REQUIRE_DIGIT = True        # å¿…é¡»åŒ…å«æ•°å­—
    REQUIRE_SPECIAL = True      # å¿…é¡»åŒ…å«ç‰¹æ®Šå­—ç¬¦
    PASSWORD_EXPIRE_DAYS = 90   # å¯†ç æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰
    MAX_LOGIN_ATTEMPTS = 5      # æœ€å¤§ç™»å½•å°è¯•æ¬¡æ•°
    LOCKOUT_DURATION_MINUTES = 30  # é”å®šæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
    
    @staticmethod
    def validate_password_strength(password: str) -> tuple[bool, str]:
        """
        éªŒè¯å¯†ç å¼ºåº¦
        
        Returns:
            (æ˜¯å¦é€šè¿‡, é”™è¯¯ä¿¡æ¯)
        """
        if len(password) < PasswordPolicy.MIN_LENGTH:
            return False, f"å¯†ç é•¿åº¦ä¸èƒ½å°‘äº{PasswordPolicy.MIN_LENGTH}ä½"
        
        if PasswordPolicy.REQUIRE_UPPERCASE and not re.search(r'[A-Z]', password):
            return False, "å¯†ç å¿…é¡»åŒ…å«å¤§å†™å­—æ¯"
        
        if PasswordPolicy.REQUIRE_LOWERCASE and not re.search(r'[a-z]', password):
            return False, "å¯†ç å¿…é¡»åŒ…å«å°å†™å­—æ¯"
        
        if PasswordPolicy.REQUIRE_DIGIT and not re.search(r'\d', password):
            return False, "å¯†ç å¿…é¡»åŒ…å«æ•°å­—"
        
        if PasswordPolicy.REQUIRE_SPECIAL and not re.search(r'[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]', password):
            return False, "å¯†ç å¿…é¡»åŒ…å«ç‰¹æ®Šå­—ç¬¦"
        
        return True, ""
```

#### å¯†ç åŠ å¯†å­˜å‚¨

```python
# backend/utils/security.py
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

def hash_password(password: str) -> str:
    """ä½¿ç”¨bcryptå“ˆå¸Œå¯†ç ï¼ˆä¸å¯é€†ï¼‰"""
    return pwd_context.hash(password)

def verify_password(plain_password: str, hashed_password: str) -> bool:
    """éªŒè¯å¯†ç """
    return pwd_context.verify(plain_password, hashed_password)
```

**ç¤ºä¾‹**:
```python
# æ³¨å†Œæ—¶
hashed = hash_password("Admin@123")
# ç»“æœï¼š$2b$12$EixZaYVK1fsbw1ZfbX3OXePaWxn96p36WQoeG6Lruj3vjPGga31lW

# ç™»å½•æ—¶
is_valid = verify_password("Admin@123", hashed)
# ç»“æœï¼šTrue
```

### 2. ç™»å½•å¤±è´¥é”å®š

#### æ•°æ®åº“å­—æ®µ

```sql
-- usersè¡¨åŒ…å«ä»¥ä¸‹å­—æ®µ
login_failures INT DEFAULT 0,                    -- è¿ç»­å¤±è´¥æ¬¡æ•°
locked_until DATETIME,                           -- é”å®šæˆªæ­¢æ—¶é—´
last_login_at DATETIME,                          -- æœ€åç™»å½•æ—¶é—´
last_login_ip VARCHAR(50)                        -- æœ€åç™»å½•IP
```

#### ç™»å½•å¤±è´¥å¤„ç†

```python
# backend/routers/auth.py

def handle_login_failure(db: Session, username: str):
    """å¤„ç†ç™»å½•å¤±è´¥"""
    user = db.query(User).filter(User.username == username).first()
    if not user:
        return
    
    # å¢åŠ å¤±è´¥æ¬¡æ•°
    user.login_failures += 1
    
    # è¶…è¿‡æœ€å¤§æ¬¡æ•°ï¼Œé”å®šè´¦å·
    if user.login_failures >= PasswordPolicy.MAX_LOGIN_ATTEMPTS:
        user.locked_until = datetime.now() + timedelta(
            minutes=PasswordPolicy.LOCKOUT_DURATION_MINUTES
        )
    
    db.commit()

def check_account_locked(user: User) -> bool:
    """æ£€æŸ¥è´¦å·æ˜¯å¦è¢«é”å®š"""
    if user.locked_until and user.locked_until > datetime.now():
        return True
    return False
```

#### ç™»å½•æˆåŠŸå¤„ç†

```python
def handle_login_success(db: Session, user: User, ip_address: str):
    """å¤„ç†ç™»å½•æˆåŠŸ"""
    user.login_failures = 0      # é‡ç½®å¤±è´¥æ¬¡æ•°
    user.locked_until = None     # è§£é™¤é”å®š
    user.last_login_at = datetime.now()
    user.last_login_ip = ip_address
    db.commit()
```

### 3. å¯†ç å®šæœŸæ›´æ¢

#### æ£€æŸ¥å¯†ç æ˜¯å¦è¿‡æœŸ

```python
def is_password_expired(user: User) -> bool:
    """æ£€æŸ¥å¯†ç æ˜¯å¦è¿‡æœŸ"""
    if not user.password_updated_at:
        return True
    
    days_since_update = (datetime.now() - user.password_updated_at).days
    return days_since_update >= PasswordPolicy.PASSWORD_EXPIRE_DAYS
```

#### å‰ç«¯æç¤º

```javascript
// ç™»å½•åæ£€æŸ¥
if (response.password_expired) {
  ElMessageBox.confirm(
    'æ‚¨çš„å¯†ç å·²è¶…è¿‡90å¤©æœªä¿®æ”¹ï¼Œä¸ºäº†è´¦å·å®‰å…¨ï¼Œè¯·ç«‹å³ä¿®æ”¹å¯†ç ï¼',
    'å¯†ç è¿‡æœŸæé†’',
    { type: 'warning' }
  ).then(() => {
    router.push('/system/profile')
  })
}
```

### 4. JWTä¼šè¯ç®¡ç†

#### Tokenç”Ÿæˆ

```python
# backend/utils/security.py
from jose import jwt
from datetime import datetime, timedelta

SECRET_KEY = "your-secret-key-keep-it-secret"
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 60 * 24  # 24å°æ—¶

def create_access_token(data: dict) -> str:
    """åˆ›å»ºè®¿é—®ä»¤ç‰Œ"""
    to_encode = data.copy()
    expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    to_encode.update({"exp": expire})
    
    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)
    return encoded_jwt
```

#### TokenéªŒè¯

```python
def get_current_user(
    token: str = Depends(oauth2_scheme),
    db: Session = Depends(get_db)
) -> User:
    """éªŒè¯Tokenå¹¶è¿”å›å½“å‰ç”¨æˆ·"""
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        username: str = payload.get("sub")
        if username is None:
            raise HTTPException(status_code=401, detail="æ— æ•ˆçš„ä»¤ç‰Œ")
    except JWTError:
        raise HTTPException(status_code=401, detail="ä»¤ç‰Œå·²è¿‡æœŸæˆ–æ— æ•ˆ")
    
    user = db.query(User).filter(User.username == username).first()
    if user is None:
        raise HTTPException(status_code=401, detail="ç”¨æˆ·ä¸å­˜åœ¨")
    
    return user
```

---

## è®¿é—®æ§åˆ¶

### 1. åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰

#### è§’è‰²å®šä¹‰

```python
# backend/models.py

class UserRole(str, enum.Enum):
    ADMIN = "ç®¡ç†å‘˜"      # æœ€é«˜æƒé™
    SECRETARY = "ç§‘ç ”ç§˜ä¹¦"  # æŸ¥çœ‹ç»Ÿè®¡æƒé™
    TEACHER = "æ™®é€šæ•™å¸ˆ"    # åŸºæœ¬æƒé™
```

#### æƒé™çŸ©é˜µ

| åŠŸèƒ½æ¨¡å— | ç®¡ç†å‘˜ | ç§‘ç ”ç§˜ä¹¦ | æ™®é€šæ•™å¸ˆ |
|---------|-------|---------|---------|
| ç”¨æˆ·ç®¡ç† | âœ… CRUD | âŒ | âŒ |
| é¡¹ç›®ç®¡ç† | âœ… å…¨éƒ¨ | âœ… æŸ¥çœ‹ | âœ… è‡ªå·±çš„ |
| è®ºæ–‡ç®¡ç† | âœ… å…¨éƒ¨ | âœ… æŸ¥çœ‹ | âœ… è‡ªå·±çš„ |
| ç»è´¹ç®¡ç† | âœ… å…¨éƒ¨ | âœ… æŸ¥çœ‹ | âœ… è‡ªå·±é¡¹ç›®çš„ |
| æˆæœç®¡ç† | âœ… å…¨éƒ¨ | âœ… æŸ¥çœ‹ | âœ… è‡ªå·±çš„ |
| ç»Ÿè®¡åˆ†æ | âœ… å…¨éƒ¨ | âœ… å…¨éƒ¨ | âœ… è‡ªå·±çš„ |
| æ“ä½œæ—¥å¿— | âœ… æŸ¥çœ‹ | âœ… æŸ¥çœ‹ | âŒ |

### 2. APIæƒé™éªŒè¯

#### éœ€è¦ç®¡ç†å‘˜æƒé™

```python
from utils.security import require_admin

@router.post("/users/")
def create_user(
    user: schemas.UserCreate,
    current_user: User = Depends(require_admin)  # åªæœ‰ç®¡ç†å‘˜å¯è®¿é—®
):
    pass
```

#### éœ€è¦ç™»å½•

```python
from utils.security import get_current_user

@router.get("/projects/")
def get_projects(
    current_user: User = Depends(get_current_user)  # éœ€è¦ç™»å½•
):
    pass
```

#### èµ„æºçº§æƒé™æ§åˆ¶

```python
@router.put("/projects/{project_id}")
def update_project(
    project_id: int,
    project: schemas.ProjectUpdate,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    # æŸ¥è¯¢é¡¹ç›®
    db_project = db.query(Project).filter(Project.id == project_id).first()
    if not db_project:
        raise HTTPException(status_code=404, detail="é¡¹ç›®ä¸å­˜åœ¨")
    
    # æƒé™éªŒè¯ï¼šç®¡ç†å‘˜æˆ–é¡¹ç›®è´Ÿè´£äºº
    if current_user.role != UserRole.ADMIN and db_project.pi_id != current_user.id:
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    
    # æ›´æ–°é¡¹ç›®
    # ...
```

### 3. å‰ç«¯è·¯ç”±å®ˆå«

```javascript
// frontend/src/router/index.js

router.beforeEach((to, from, next) => {
  const token = localStorage.getItem('token')
  const userStore = useUserStore()
  
  // éœ€è¦ç™»å½•çš„é¡µé¢
  if (to.path !== '/login' && !token) {
    next('/login')
    return
  }
  
  // éœ€è¦ç®¡ç†å‘˜æƒé™çš„é¡µé¢
  if (to.meta.requiresAdmin && userStore.user?.role !== 'ç®¡ç†å‘˜') {
    ElMessage.error('æƒé™ä¸è¶³')
    next(false)
    return
  }
  
  next()
})
```

---

## å®‰å…¨å®¡è®¡

### 1. å®¡è®¡æ—¥å¿—è®°å½•

#### æ—¥å¿—ç»“æ„

```sql
CREATE TABLE operation_logs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT COMMENT 'ç”¨æˆ·ID',
    username VARCHAR(50) COMMENT 'ç”¨æˆ·å',
    operation VARCHAR(100) NOT NULL COMMENT 'æ“ä½œç±»å‹',
    module VARCHAR(50) NOT NULL COMMENT 'æ¨¡å—åç§°',
    method VARCHAR(10) COMMENT 'HTTPæ–¹æ³•',
    path VARCHAR(200) COMMENT 'è¯·æ±‚è·¯å¾„',
    details TEXT COMMENT 'æ“ä½œè¯¦æƒ…ï¼ˆJSONï¼‰',
    ip_address VARCHAR(50) NOT NULL COMMENT 'IPåœ°å€',
    user_agent VARCHAR(500) COMMENT 'ç”¨æˆ·ä»£ç†',
    status VARCHAR(20) COMMENT 'æ“ä½œç»“æœï¼ˆSUCCESS/FAILEDï¼‰',
    error_msg TEXT COMMENT 'é”™è¯¯ä¿¡æ¯',
    duration INT COMMENT 'æ‰§è¡Œæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### è®°å½•æ“ä½œæ—¥å¿—

```python
# backend/utils/audit.py

class AuditLogger:
    """å®¡è®¡æ—¥å¿—å·¥å…·ç±»"""
    
    @staticmethod
    def log_operation(
        db: Session,
        user_id: int,
        username: str,
        operation: str,
        module: str,
        request: Request,
        details: dict = None,
        status: str = "SUCCESS",
        error_msg: str = None,
        duration: int = None
    ):
        """è®°å½•æ“ä½œæ—¥å¿—"""
        log = OperationLog(
            user_id=user_id,
            username=username,
            operation=operation,
            module=module,
            method=request.method,
            path=str(request.url.path),
            details=json.dumps(details, ensure_ascii=False) if details else None,
            ip_address=request.client.host,
            user_agent=request.headers.get("user-agent"),
            status=status,
            error_msg=error_msg,
            duration=duration
        )
        db.add(log)
        db.commit()
    
    @staticmethod
    def log_create(db, user_id, username, module, resource_type, resource_id, request, data=None):
        """è®°å½•åˆ›å»ºæ“ä½œ"""
        details = {"resource_type": resource_type, "resource_id": resource_id}
        if data:
            details.update(data)
        
        AuditLogger.log_operation(
            db=db,
            user_id=user_id,
            username=username,
            operation=f"åˆ›å»º{resource_type}",
            module=module,
            request=request,
            details=details
        )
    
    @staticmethod
    def log_update(db, user_id, username, module, resource_type, resource_id, request, data=None):
        """è®°å½•æ›´æ–°æ“ä½œ"""
        details = {"resource_type": resource_type, "resource_id": resource_id}
        if data:
            details.update(data)
        
        AuditLogger.log_operation(
            db=db,
            user_id=user_id,
            username=username,
            operation=f"æ›´æ–°{resource_type}",
            module=module,
            request=request,
            details=details
        )
```

#### ä½¿ç”¨ç¤ºä¾‹

```python
@router.post("/projects/", response_model=schemas.ProjectResponse)
def create_project(
    project: schemas.ProjectCreate,
    request: Request,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    timer = Timer()
    timer.start()
    
    try:
        # åˆ›å»ºé¡¹ç›®
        db_project = crud_project.create_project(db, project, current_user.id)
        
        # è®°å½•å®¡è®¡æ—¥å¿—
        AuditLogger.log_create(
            db=db,
            user_id=current_user.id,
            username=current_user.username,
            module="project",
            resource_type="é¡¹ç›®",
            resource_id=db_project.id,
            request=request,
            data={"project_name": project.project_name}
        )
        
        return db_project
    except Exception as e:
        # è®°å½•å¤±è´¥æ—¥å¿—
        AuditLogger.log_operation(
            db=db,
            user_id=current_user.id,
            username=current_user.username,
            operation="åˆ›å»ºé¡¹ç›®å¤±è´¥",
            module="project",
            request=request,
            status="FAILED",
            error_msg=str(e),
            duration=timer.elapsed_ms()
        )
        raise
```

### 2. éœ€è¦è®°å½•çš„æ“ä½œ

#### å¿…é¡»è®°å½•çš„æ“ä½œ

- âœ… ç™»å½•æˆåŠŸ/å¤±è´¥
- âœ… ç™»å‡º
- âœ… ä¿®æ”¹å¯†ç 
- âœ… åˆ›å»º/ç¼–è¾‘/åˆ é™¤ç”¨æˆ·
- âœ… åˆ›å»º/ç¼–è¾‘/åˆ é™¤é¡¹ç›®
- âœ… åˆ›å»º/ç¼–è¾‘/åˆ é™¤è®ºæ–‡
- âœ… åˆ›å»º/ç¼–è¾‘/åˆ é™¤ç»è´¹è®°å½•
- âœ… åˆ›å»º/ç¼–è¾‘/åˆ é™¤æˆæœ
- âœ… å¯¼å‡ºæ•°æ®
- âœ… æƒé™æ‹’ç»

#### æ—¥å¿—æŸ¥è¯¢ç¤ºä¾‹

```sql
-- æŸ¥è¯¢æŸç”¨æˆ·çš„æ“ä½œè®°å½•
SELECT * FROM operation_logs
WHERE user_id = 1
ORDER BY created_at DESC
LIMIT 100;

-- æŸ¥è¯¢ç™»å½•å¤±è´¥è®°å½•
SELECT username, ip_address, created_at
FROM operation_logs
WHERE operation = 'ç™»å½•å¤±è´¥'
AND created_at > DATE_SUB(NOW(), INTERVAL 7 DAY);

-- æŸ¥è¯¢åˆ é™¤æ“ä½œ
SELECT * FROM operation_logs
WHERE operation LIKE '%åˆ é™¤%'
ORDER BY created_at DESC;

-- ç»Ÿè®¡å„æ“ä½œç±»å‹çš„æ•°é‡
SELECT operation, COUNT(*) as count
FROM operation_logs
GROUP BY operation
ORDER BY count DESC;
```

### 3. æ—¥å¿—ä¿æŠ¤

#### æ—¥å¿—ä¿ç•™ç­–ç•¥

```python
# å®šæœŸæ¸…ç†90å¤©å‰çš„æ—¥å¿—
DELETE FROM operation_logs
WHERE created_at < DATE_SUB(NOW(), INTERVAL 90 DAY);
```

#### æ—¥å¿—å¤‡ä»½

```bash
#!/bin/bash
# æ¯å‘¨å¤‡ä»½å®¡è®¡æ—¥å¿—
mysqldump -u root -p research_management_system operation_logs > \
  /backup/audit_logs_$(date +%Y%m%d).sql
```

---

## æ•°æ®å®Œæ•´æ€§

### 1. æ•°æ®åº“çº¦æŸ

#### å¤–é”®çº¦æŸ

```sql
-- é¡¹ç›®è¡¨
ALTER TABLE projects
ADD CONSTRAINT fk_project_pi
FOREIGN KEY (pi_id) REFERENCES users(id)
ON DELETE RESTRICT;  -- ç¦æ­¢åˆ é™¤æœ‰é¡¹ç›®çš„ç”¨æˆ·

-- è®ºæ–‡è¡¨
ALTER TABLE papers
ADD CONSTRAINT fk_paper_project
FOREIGN KEY (project_id) REFERENCES projects(id)
ON DELETE SET NULL;  -- åˆ é™¤é¡¹ç›®æ—¶ï¼Œè®ºæ–‡çš„project_idè®¾ä¸ºNULL

-- ç»è´¹è¡¨
ALTER TABLE funds
ADD CONSTRAINT fk_fund_project
FOREIGN KEY (project_id) REFERENCES projects(id)
ON DELETE CASCADE;  -- åˆ é™¤é¡¹ç›®æ—¶ï¼Œçº§è”åˆ é™¤ç»è´¹è®°å½•
```

#### å”¯ä¸€çº¦æŸ

```sql
-- ç”¨æˆ·åå”¯ä¸€
ALTER TABLE users
ADD CONSTRAINT uk_username UNIQUE (username);

-- é‚®ç®±å”¯ä¸€
ALTER TABLE users
ADD CONSTRAINT uk_email UNIQUE (email);
```

#### éç©ºçº¦æŸ

```sql
-- å¿…å¡«å­—æ®µ
ALTER TABLE projects
MODIFY COLUMN project_name VARCHAR(200) NOT NULL,
MODIFY COLUMN pi_id INT NOT NULL;
```

### 2. äº‹åŠ¡å¤„ç†

```python
from sqlalchemy.exc import SQLAlchemyError

def create_project_with_members(db: Session, project_data: dict, members: list):
    """åˆ›å»ºé¡¹ç›®å¹¶æ·»åŠ æˆå‘˜ï¼ˆäº‹åŠ¡å¤„ç†ï¼‰"""
    try:
        # å¼€å§‹äº‹åŠ¡
        db.begin()
        
        # åˆ›å»ºé¡¹ç›®
        project = Project(**project_data)
        db.add(project)
        db.flush()  # è·å–project.id
        
        # æ·»åŠ æˆå‘˜
        for member in members:
            project_member = ProjectMember(
                project_id=project.id,
                user_id=member['user_id']
            )
            db.add(project_member)
        
        # æäº¤äº‹åŠ¡
        db.commit()
        return project
        
    except SQLAlchemyError as e:
        # å›æ»šäº‹åŠ¡
        db.rollback()
        raise HTTPException(status_code=500, detail=f"åˆ›å»ºå¤±è´¥ï¼š{str(e)}")
```

### 3. è¾“å…¥éªŒè¯

#### Pydanticæ•°æ®éªŒè¯

```python
from pydantic import BaseModel, Field, EmailStr, validator

class UserCreate(BaseModel):
    username: str = Field(..., min_length=3, max_length=50, description="ç”¨æˆ·å")
    password: str = Field(..., min_length=8, description="å¯†ç ")
    name: str = Field(..., min_length=2, max_length=50, description="å§“å")
    email: EmailStr = Field(..., description="é‚®ç®±")
    phone: Optional[str] = Field(None, regex=r'^\d{11}$', description="æ‰‹æœºå·")
    
    @validator('username')
    def username_alphanumeric(cls, v):
        """ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿"""
        if not re.match(r'^[a-zA-Z0-9_]+$', v):
            raise ValueError('ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿')
        return v
    
    @validator('password')
    def password_strength(cls, v):
        """éªŒè¯å¯†ç å¼ºåº¦"""
        is_valid, error_msg = PasswordPolicy.validate_password_strength(v)
        if not is_valid:
            raise ValueError(error_msg)
        return v
```

---

## å®‰å…¨é…ç½®

### 1. ç¯å¢ƒå˜é‡é…ç½®

```bash
# backend/.env
DATABASE_URL=mysql+pymysql://user:password@localhost:3306/database
SECRET_KEY=your-super-secret-key-keep-it-safe
DEBUG=False
ALLOWED_HOSTS=your-domain.com
```

```python
# backend/config.py
from pydantic import BaseSettings

class Settings(BaseSettings):
    database_url: str
    secret_key: str
    debug: bool = False
    allowed_hosts: list[str] = []
    
    class Config:
        env_file = ".env"

settings = Settings()
```

### 2. HTTPSé…ç½®

```nginx
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl;
    server_name your-domain.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    
    # ...
}
```

### 3. å®‰å…¨å“åº”å¤´

```python
# backend/main.py
from fastapi.middleware.trustedhost import TrustedHostMiddleware
from fastapi.middleware.httpsredirect import HTTPSRedirectMiddleware

app = FastAPI()

# åªå…è®¸ç‰¹å®šåŸŸåè®¿é—®
app.add_middleware(
    TrustedHostMiddleware,
    allowed_hosts=["your-domain.com", "*.your-domain.com"]
)

# å¼ºåˆ¶HTTPS
if not settings.debug:
    app.add_middleware(HTTPSRedirectMiddleware)

# æ·»åŠ å®‰å…¨å“åº”å¤´
@app.middleware("http")
async def add_security_headers(request: Request, call_next):
    response = await call_next(request)
    response.headers["X-Content-Type-Options"] = "nosniff"
    response.headers["X-Frame-Options"] = "DENY"
    response.headers["X-XSS-Protection"] = "1; mode=block"
    response.headers["Strict-Transport-Security"] = "max-age=31536000; includeSubDomains"
    return response
```

---

## å®‰å…¨æœ€ä½³å®è·µ

### 1. SQLæ³¨å…¥é˜²æŠ¤

**âŒ é”™è¯¯ç¤ºä¾‹ï¼ˆæ‹¼æ¥SQLï¼‰**:
```python
# ä¸è¦è¿™æ ·åšï¼
query = f"SELECT * FROM users WHERE username = '{username}'"
db.execute(query)
```

**âœ… æ­£ç¡®ç¤ºä¾‹ï¼ˆå‚æ•°åŒ–æŸ¥è¯¢ï¼‰**:
```python
# ä½¿ç”¨ORM
user = db.query(User).filter(User.username == username).first()

# æˆ–ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
query = "SELECT * FROM users WHERE username = :username"
db.execute(query, {"username": username})
```

### 2. XSSé˜²æŠ¤

**å‰ç«¯è¾“å‡ºè½¬ä¹‰**:
```vue
<!-- Vueè‡ªåŠ¨è½¬ä¹‰ -->
<div>{{ userInput }}</div>

<!-- å¦‚æœå¿…é¡»ä½¿ç”¨v-htmlï¼Œå…ˆæ¸…ç†å†…å®¹ -->
<div v-html="sanitizeHTML(userInput)"></div>
```

```javascript
import DOMPurify from 'dompurify'

const sanitizeHTML = (html) => {
  return DOMPurify.sanitize(html)
}
```

### 3. CSRFé˜²æŠ¤

```python
# FastAPIä½¿ç”¨JWTï¼Œå¤©ç„¶é˜²æŠ¤CSRF
# ç¡®ä¿Tokenå­˜å‚¨åœ¨localStorageè€ŒéCookie
```

### 4. æ•æ„Ÿä¿¡æ¯ä¿æŠ¤

```python
# å“åº”ä¸­ä¸è¿”å›å¯†ç å­—æ®µ
class UserResponse(BaseModel):
    id: int
    username: str
    name: str
    # password_hash ä¸åŒ…å«åœ¨å“åº”ä¸­
    
    class Config:
        from_attributes = True
```

### 5. æ–‡ä»¶ä¸Šä¼ å®‰å…¨

```python
ALLOWED_EXTENSIONS = {'.pdf', '.doc', '.docx', '.xlsx', '.jpg', '.png'}
MAX_FILE_SIZE = 10 * 1024 * 1024  # 10MB

def validate_file(file: UploadFile):
    """éªŒè¯ä¸Šä¼ æ–‡ä»¶"""
    # æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
    ext = os.path.splitext(file.filename)[1].lower()
    if ext not in ALLOWED_EXTENSIONS:
        raise HTTPException(status_code=400, detail="ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹")
    
    # æ£€æŸ¥æ–‡ä»¶å¤§å°
    file.file.seek(0, 2)
    file_size = file.file.tell()
    file.file.seek(0)
    
    if file_size > MAX_FILE_SIZE:
        raise HTTPException(status_code=400, detail="æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶")
    
    # é‡å‘½åæ–‡ä»¶ï¼ˆé˜²æ­¢è·¯å¾„éå†ï¼‰
    safe_filename = f"{uuid.uuid4()}{ext}"
    return safe_filename
```

---

## åº”æ€¥å“åº”

### 1. å®‰å…¨äº‹ä»¶ç±»å‹

| äº‹ä»¶ç±»å‹ | ä¸¥é‡ç¨‹åº¦ | å“åº”æ—¶é—´ |
|---------|---------|---------|
| æš´åŠ›ç ´è§£ | ä¸­ | 30åˆ†é’Ÿ |
| æœªæˆæƒè®¿é—® | é«˜ | 10åˆ†é’Ÿ |
| æ•°æ®æ³„éœ² | ä¸¥é‡ | ç«‹å³ |
| SQLæ³¨å…¥å°è¯• | é«˜ | 10åˆ†é’Ÿ |
| DDoSæ”»å‡» | é«˜ | 10åˆ†é’Ÿ |

### 2. åº”æ€¥å“åº”æµç¨‹

```
1. å‘ç°å¼‚å¸¸ â†’ 2. ç¡®è®¤äº‹ä»¶ â†’ 3. éš”ç¦»å½±å“ â†’ 4. åˆ†æåŸå›  â†’ 5. ä¿®å¤æ¼æ´ â†’ 6. æ¢å¤æœåŠ¡ â†’ 7. æ€»ç»“æŠ¥å‘Š
```

### 3. å¸¸è§å®‰å…¨äº‹ä»¶å¤„ç†

#### å‘ç°æš´åŠ›ç ´è§£

```sql
-- æŸ¥è¯¢ç™»å½•å¤±è´¥è®°å½•
SELECT username, ip_address, COUNT(*) as attempts
FROM operation_logs
WHERE operation = 'ç™»å½•å¤±è´¥'
AND created_at > DATE_SUB(NOW(), INTERVAL 1 HOUR)
GROUP BY username, ip_address
HAVING attempts > 10;

-- é”å®šå—æ”»å‡»è´¦å·
UPDATE users
SET locked_until = DATE_ADD(NOW(), INTERVAL 1 HOUR)
WHERE username IN (SELECT username FROM ...);

-- æ·»åŠ IPé»‘åå•ï¼ˆé˜²ç«å¢™ï¼‰
sudo ufw deny from <æ”»å‡»IP>
```

#### å‘ç°æœªæˆæƒè®¿é—®

```sql
-- æŸ¥è¯¢æƒé™æ‹’ç»è®°å½•
SELECT * FROM operation_logs
WHERE status = 'FAILED'
AND error_msg LIKE '%æƒé™%'
ORDER BY created_at DESC;

-- ç«‹å³é‡ç½®å—å½±å“ç”¨æˆ·çš„å¯†ç 
UPDATE users
SET password_hash = '<ä¸´æ—¶å¯†ç å“ˆå¸Œ>'
WHERE id = <ç”¨æˆ·ID>;
```

### 4. å®‰å…¨ç›‘æ§è„šæœ¬

```python
# scripts/security_monitor.py
import smtplib
from email.mime.text import MIMEText

def check_failed_logins():
    """æ£€æŸ¥å¼‚å¸¸ç™»å½•"""
    query = """
    SELECT username, ip_address, COUNT(*) as attempts
    FROM operation_logs
    WHERE operation = 'ç™»å½•å¤±è´¥'
    AND created_at > DATE_SUB(NOW(), INTERVAL 1 HOUR)
    GROUP BY username, ip_address
    HAVING attempts > 10
    """
    result = db.execute(query).fetchall()
    
    if result:
        send_alert(f"æ£€æµ‹åˆ°æš´åŠ›ç ´è§£ï¼š{result}")

def check_unauthorized_access():
    """æ£€æŸ¥æœªæˆæƒè®¿é—®"""
    query = """
    SELECT COUNT(*) as count
    FROM operation_logs
    WHERE status = 'FAILED'
    AND error_msg LIKE '%æƒé™%'
    AND created_at > DATE_SUB(NOW(), INTERVAL 1 HOUR)
    """
    count = db.execute(query).scalar()
    
    if count > 50:
        send_alert(f"æ£€æµ‹åˆ°å¤§é‡æœªæˆæƒè®¿é—®ï¼š{count}æ¬¡")

def send_alert(message: str):
    """å‘é€å‘Šè­¦é‚®ä»¶"""
    msg = MIMEText(f"å®‰å…¨å‘Šè­¦ï¼š{message}")
    msg['Subject'] = 'ã€å®‰å…¨å‘Šè­¦ã€‘ç§‘ç ”ç®¡ç†ç³»ç»Ÿ'
    msg['From'] = 'alert@example.com'
    msg['To'] = 'admin@example.com'
    
    server = smtplib.SMTP('smtp.example.com')
    server.send_message(msg)
    server.quit()

if __name__ == "__main__":
    check_failed_logins()
    check_unauthorized_access()
```

**æ·»åŠ åˆ°crontabï¼ˆæ¯5åˆ†é’Ÿæ‰§è¡Œï¼‰**:
```bash
*/5 * * * * /usr/bin/python3 /path/to/security_monitor.py
```

---

## å®‰å…¨æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰æ£€æŸ¥

- [ ] ä¿®æ”¹æ‰€æœ‰é»˜è®¤å¯†ç 
- [ ] é…ç½®HTTPSè¯ä¹¦
- [ ] é…ç½®é˜²ç«å¢™è§„åˆ™
- [ ] å…³é—­ä¸å¿…è¦çš„ç«¯å£
- [ ] é…ç½®æ•°æ®åº“è®¿é—®ç™½åå•
- [ ] å¯ç”¨å®¡è®¡æ—¥å¿—
- [ ] é…ç½®æ—¥å¿—è½®è½¬
- [ ] è®¾ç½®ä¼šè¯è¶…æ—¶
- [ ] é…ç½®å¤‡ä»½ç­–ç•¥

### æ—¥å¸¸è¿ç»´æ£€æŸ¥

- [ ] æ£€æŸ¥ç™»å½•å¤±è´¥æ—¥å¿—
- [ ] æ£€æŸ¥æƒé™æ‹’ç»æ—¥å¿—
- [ ] æ£€æŸ¥ç³»ç»Ÿèµ„æºä½¿ç”¨
- [ ] æ£€æŸ¥æ•°æ®åº“æ…¢æŸ¥è¯¢
- [ ] æ£€æŸ¥å¤‡ä»½æ˜¯å¦æ­£å¸¸
- [ ] æ›´æ–°ç³»ç»Ÿè¡¥ä¸
- [ ] æ£€æŸ¥SSLè¯ä¹¦æœ‰æ•ˆæœŸ

### æœˆåº¦å®‰å…¨å®¡è®¡

- [ ] å®¡æŸ¥ç”¨æˆ·æƒé™
- [ ] å®¡æŸ¥æ“ä½œæ—¥å¿—
- [ ] æ£€æŸ¥å¯†ç è¿‡æœŸæƒ…å†µ
- [ ] å®¡æŸ¥å¼‚å¸¸è¡Œä¸º
- [ ] æ›´æ–°å®‰å…¨ç­–ç•¥
- [ ] è¿›è¡Œå®‰å…¨åŸ¹è®­

---

**å®‰å…¨æ˜¯æŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦å®šæœŸæ£€æŸ¥å’Œæ›´æ–°ï¼** ğŸ”’
