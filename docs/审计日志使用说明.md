# 安全审计日志功能使用说明

## 🔐 功能概述

安全审计日志功能是符合**等保二级要求**的重要安全特性，用于记录和查询系统中所有用户的操作行为，便于安全审计和问题追溯。

---

## 📋 功能特性

### 1. 审计日志记录（自动）

系统自动记录以下操作：

✅ **认证操作**
- 用户登录成功/失败
- 用户注册
- 密码修改

✅ **数据操作**
- 创建、编辑、删除项目
- 创建、编辑、删除论文
- 创建、编辑、删除经费记录
- 创建、编辑、删除成果
- 创建、编辑、删除用户

✅ **权限操作**
- 权限拒绝记录
- 越权访问尝试

### 2. 日志信息包含

每条审计日志包含以下信息：

| 字段 | 说明 | 示例 |
|------|------|------|
| 用户ID | 操作用户的ID | 1 |
| 用户名 | 操作用户的用户名 | admin |
| 操作类型 | 具体的操作名称 | 登录、创建项目、删除论文 |
| 模块名称 | 所属功能模块 | auth、project、paper |
| 请求方法 | HTTP方法 | GET、POST、PUT、DELETE |
| 请求路径 | API路径 | /api/projects/1 |
| 操作详情 | JSON格式的详细信息 | {"project_name": "..."} |
| IP地址 | 客户端IP地址 | 192.168.1.100 |
| 用户代理 | 浏览器信息 | Mozilla/5.0... |
| 操作结果 | SUCCESS或FAILED | SUCCESS |
| 错误信息 | 失败时的错误原因 | 权限不足 |
| 执行时间 | 接口执行耗时（毫秒） | 120 |
| 操作时间 | 操作发生时间 | 2024-12-02 15:30:45 |

---

## 🎯 使用指南

### 1. 访问权限

- **管理员**：可以查看所有审计日志
- **科研秘书**：可以查看所有审计日志
- **普通教师**：无法访问审计日志

### 2. 访问路径

登录系统后：

1. 点击左侧菜单 **"审计日志"**
2. 进入审计日志查询页面

### 3. 查询功能

#### 3.1 基础查询

支持以下筛选条件：

- **用户名**：模糊搜索，如输入 "admin" 查找所有包含admin的用户操作
- **操作类型**：模糊搜索，如输入 "登录" 查找所有登录操作
- **模块**：下拉选择（认证、用户、项目、论文、经费、成果）
- **状态**：下拉选择（成功、失败）
- **日期范围**：选择开始日期和结束日期

#### 3.2 查询步骤

1. 在搜索区域填写筛选条件
2. 点击 **"搜索"** 按钮
3. 查看查询结果
4. 点击 **"重置"** 清空筛选条件

#### 3.3 查看详情

- **展开行**：点击表格行左侧的箭头，展开查看完整信息
- **详情按钮**：点击操作列的 **"详情"** 按钮，弹窗查看完整日志信息

### 4. 统计分析

点击右上角 **"查看统计"** 按钮，可以查看：

✅ **操作类型TOP10**
- 最频繁的10种操作类型及次数

✅ **活跃用户TOP10**
- 操作最多的10个用户及次数

✅ **操作结果统计**
- 成功操作次数
- 失败操作次数

✅ **统计范围选择**
- 最近7天
- 最近30天
- 最近90天

---

## 📊 使用场景

### 场景1：排查登录异常

**需求**：发现账号被异常登录

**步骤**：
1. 筛选条件：操作类型输入 "登录"，状态选择 "成功"
2. 查看登录IP地址和时间
3. 发现可疑IP或时间点
4. 采取安全措施（锁定账号、修改密码）

### 场景2：追踪数据修改

**需求**：某个项目被误删除，需要追查谁删除的

**步骤**：
1. 筛选条件：操作类型输入 "删除"，模块选择 "项目"
2. 查看删除操作记录
3. 点击详情查看删除的项目信息
4. 联系相关人员确认

### 场景3：安全审计

**需求**：定期进行安全审计，查看是否有异常操作

**步骤**：
1. 点击 "查看统计"
2. 选择统计范围（如最近30天）
3. 查看失败操作统计
4. 如发现大量失败操作，进一步筛选查看详情

### 场景4：权限违规检查

**需求**：检查是否有越权访问尝试

**步骤**：
1. 筛选条件：操作类型输入 "权限"，状态选择 "失败"
2. 查看权限拒绝记录
3. 分析是否存在恶意尝试
4. 必要时锁定账号或调整权限

---

## 🔍 API接口文档

### 1. 查询审计日志

**接口**: `GET /api/audit/logs`

**权限**: 管理员、科研秘书

**参数**:
```json
{
  "page": 1,              // 页码
  "page_size": 20,        // 每页数量
  "username": "admin",    // 用户名（可选）
  "operation": "登录",    // 操作类型（可选）
  "module": "auth",       // 模块名称（可选）
  "status": "SUCCESS",    // 操作结果（可选）
  "start_date": "2024-12-01",  // 开始日期（可选）
  "end_date": "2024-12-02"     // 结束日期（可选）
}
```

**响应**:
```json
{
  "total": 100,
  "page": 1,
  "page_size": 20,
  "data": [
    {
      "id": 1,
      "user_id": 1,
      "username": "admin",
      "operation": "登录",
      "module": "auth",
      "method": "POST",
      "path": "/api/auth/login",
      "details": "{\"username\": \"admin\"}",
      "ip_address": "127.0.0.1",
      "user_agent": "Mozilla/5.0...",
      "status": "SUCCESS",
      "error_msg": null,
      "duration": 150,
      "created_at": "2024-12-02 15:30:45"
    }
  ]
}
```

### 2. 查询日志详情

**接口**: `GET /api/audit/logs/{log_id}`

**权限**: 管理员、科研秘书

**响应**: 返回单条日志的完整信息

### 3. 统计分析

**接口**: `GET /api/audit/logs/statistics`

**权限**: 管理员、科研秘书

**参数**:
```json
{
  "days": 7  // 统计最近N天（1-90）
}
```

**响应**:
```json
{
  "operation_stats": [
    {"operation": "登录", "count": 150},
    {"operation": "创建项目", "count": 45}
  ],
  "status_stats": [
    {"status": "SUCCESS", "count": 180},
    {"status": "FAILED", "count": 15}
  ],
  "user_stats": [
    {"username": "admin", "count": 80},
    {"username": "teacher1", "count": 50}
  ],
  "daily_stats": [
    {"date": "2024-12-01", "count": 95},
    {"date": "2024-12-02", "count": 100}
  ]
}
```

---

## ⚠️ 注意事项

1. **日志不可删除**：审计日志一旦生成，无法删除或修改，确保审计追溯性
2. **定期备份**：建议定期备份审计日志数据库
3. **日志保留**：建议至少保留90天的审计日志
4. **敏感信息**：日志中不会记录密码等敏感信息，只记录操作行为
5. **性能考虑**：大量查询时建议使用日期范围筛选，避免全表查询

---

## 📈 等保合规性

本功能符合**等保二级**关于安全审计的要求：

✅ **安全审计要求**
- 启用安全审计功能，审计覆盖到每个用户
- 对重要的用户行为和重要安全事件进行审计
- 审计记录包括事件的日期和时间、用户、事件类型、事件是否成功及其他与审计相关的信息

✅ **审计记录保护**
- 审计记录不可被普通用户访问和修改
- 仅管理员和科研秘书可以查看审计日志
- 日志记录失败不影响业务正常运行

✅ **审计记录内容**
- 用户身份标识（用户ID、用户名）
- 操作时间（精确到秒）
- 操作类型和操作对象
- 操作结果（成功/失败）
- 客户端IP地址

---

## 🚀 快速开始

### 管理员操作

1. 登录系统（使用管理员账号）
2. 点击左侧菜单 **"审计日志"**
3. 默认显示最近的审计记录
4. 使用筛选条件查询特定日志
5. 点击 **"查看统计"** 查看统计分析

### 科研秘书操作

1. 登录系统（使用科研秘书账号）
2. 点击左侧菜单 **"审计日志"**
3. 查看和查询审计日志（与管理员权限相同）

---

## 📞 技术支持

如有问题，请联系系统管理员或查看开发文档。
