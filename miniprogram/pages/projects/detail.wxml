<!--pages/projects/detail.wxml-->
<wxs module="moneyUtil">
  var formatMoney = function(amount) {
    if (!amount && amount !== 0) return '0.00'
    return Number(amount).toFixed(2)
  }
  module.exports = {
    formatMoney: formatMoney
  }
</wxs>

<view class="container">
  <!-- 项目基本信息卡片 -->
  <view class="header-card card">
    <view class="project-title">{{project.project_name || '加载中...'}}</view>
    <view class="project-meta">
      <text class="tag tag-{{getStatusType(project.status)}}">{{project.status}}</text>
      <text class="project-code" wx:if="{{project.project_code}}">编号：{{project.project_code}}</text>
    </view>
  </view>

  <!-- Tab选项卡 -->
  <view class="tab-bar card">
    <view 
      wx:for="{{tabList}}" 
      wx:key="index"
      class="tab-item {{activeTab === index ? 'active' : ''}}"
      data-index="{{index}}"
      bindtap="onTabChange"
    >
      {{item}}
    </view>
  </view>

  <!-- Tab内容 -->
  <view class="tab-content">
    <!-- 基本信息 -->
    <view wx:if="{{activeTab === 0}}">
      <view class="info-card card">
        <view class="card-title">项目信息</view>
        <view class="info-item">
          <view class="info-label">项目名称</view>
          <view class="info-value">{{project.project_name}}</view>
        </view>
        <view class="info-item">
          <view class="info-label">项目编号</view>
          <view class="info-value">{{project.project_code || '未设置'}}</view>
        </view>
        <view class="info-item">
          <view class="info-label">项目状态</view>
          <view class="info-value">
            <text class="tag tag-{{getStatusType(project.status)}}">{{project.status}}</text>
          </view>
        </view>
        <view class="info-item">
          <view class="info-label">项目类型</view>
          <view class="info-value">{{project.project_type || '未设置'}}</view>
        </view>
        <view class="info-item">
          <view class="info-label">项目级别</view>
          <view class="info-value">{{project.project_level || '未设置'}}</view>
        </view>
      </view>

      <view class="info-card card">
        <view class="card-title">责任信息</view>
        <view class="info-item">
          <view class="info-label">项目负责人</view>
          <view class="info-value">{{project.pi_name}}</view>
        </view>
        <view class="info-item" wx:if="{{project.college}}">
          <view class="info-label">所在学院</view>
          <view class="info-value">{{project.college}}</view>
        </view>
      </view>

      <view class="info-card card">
        <view class="card-title">经费信息</view>
        <view class="info-item">
          <view class="info-label">总预算</view>
          <view class="info-value text-primary">￥{{moneyUtil.formatMoney(project.budget_total)}}</view>
        </view>
      </view>

      <view class="info-card card">
        <view class="card-title">时间信息</view>
        <view class="info-item">
          <view class="info-label">立项日期</view>
          <view class="info-value">{{formatDate(project.start_date)}}</view>
        </view>
        <view class="info-item">
          <view class="info-label">结题日期</view>
          <view class="info-value">{{formatDate(project.end_date)}}</view>
        </view>
      </view>

      <view class="info-card card" wx:if="{{project.description}}">
        <view class="card-title">项目简介</view>
        <view class="description">{{project.description}}</view>
      </view>
    </view>

    <!-- 项目成员 -->
    <view wx:if="{{activeTab === 1}}">
      <view class="members-card card">
        <view class="card-title">项目成员列表</view>
        <view wx:if="{{members.length > 0}}">
          <view 
            wx:for="{{members}}" 
            wx:key="id"
            class="member-item"
          >
            <view class="member-info">
              <view class="member-name">{{item.user.real_name}}</view>
              <view class="member-role">{{item.role}}</view>
            </view>
            <view class="member-contribution" wx:if="{{item.contribution}}">
              贡献度：{{item.contribution}}%
            </view>
          </view>
        </view>
        <view wx:else class="empty">
          <text class="empty-text">暂无项目成员</text>
        </view>
      </view>
    </view>

    <!-- 项目成果 -->
    <view wx:if="{{activeTab === 2}}">
      <!-- 相关论文 -->
      <view class="result-card card">
        <view class="card-title">相关论文（{{papers.length}}）</view>
        <view wx:if="{{papers.length > 0}}">
          <view 
            wx:for="{{papers}}" 
            wx:key="id"
            class="result-item"
            bindtap="goToPaperDetail"
            data-id="{{item.id}}"
          >
            <view class="result-title">{{item.title}}</view>
            <view class="result-desc">
              <text>{{item.journal}}</text>
              <text class="ml-10" wx:if="{{item.jcr_zone}}">
                <text class="tag tag-warning">JCR {{item.jcr_zone}}</text>
              </text>
            </view>
            <view class="result-date">{{formatDate(item.publication_date)}}</view>
          </view>
        </view>
        <view wx:else class="empty">
          <text class="empty-text">暂无相关论文</text>
        </view>
      </view>

      <!-- 相关成果 -->
      <view class="result-card card">
        <view class="card-title">科研成果（{{achievements.length}}）</view>
        <view wx:if="{{achievements.length > 0}}">
          <view 
            wx:for="{{achievements}}" 
            wx:key="id"
            class="result-item"
          >
            <view class="result-title">{{item.achievement_name}}</view>
            <view class="result-desc">
              <text>{{item.achievement_type}}</text>
              <text class="ml-10">
                <text class="tag tag-{{item.level === '国家级' ? 'danger' : 'info'}}">{{item.level}}</text>
              </text>
            </view>
            <view class="result-date">{{formatDate(item.award_date)}}</view>
          </view>
        </view>
        <view wx:else class="empty">
          <text class="empty-text">暂无科研成果</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 加载提示 -->
  <view wx:if="{{loading}}" class="loading">
    <text>加载中...</text>
  </view>
</view>